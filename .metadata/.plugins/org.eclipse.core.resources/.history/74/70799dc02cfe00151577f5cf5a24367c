package com.cwenhui.chowhound.ui;

import java.util.List;

import com.cwenhui.chowhound.adapter.OrderConfirmAdapter;
import com.cwenhui.chowhound.bean.GoodsBean;
import com.example.chowhound.R;
import com.handmark.pulltorefresh.library.PullToRefreshBase;
import com.handmark.pulltorefresh.library.PullToRefreshBase.Mode;
import com.handmark.pulltorefresh.library.PullToRefreshBase.OnRefreshListener2;
import com.handmark.pulltorefresh.library.PullToRefreshScrollView;

import android.app.Activity;
import android.os.Bundle;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ListAdapter;
import android.widget.ListView;
import android.widget.ScrollView;
import android.widget.TextView;
import android.widget.Toast;

public class OrderTakingActivity extends Activity implements OnRefreshListener2<ScrollView>{
	private static final String TAG = "OrderTakingActivity";
	private TextView orderAmount, realAmount;		//订单金额和实付金额
	private ListView lvOrderedGoods;				//显示已下订单商品的listview
	private PullToRefreshScrollView scrollVew;
	private List<GoodsBean> orderedGoods;			//已下订单的商品
	private OrderConfirmAdapter adapter;			
	private int sum = 0;							//总额

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_order_taking);
		
		initData();
		initView();
		initEvent();
	}
	
	@SuppressWarnings("unchecked")
	private void initData() {
		orderedGoods = (List<GoodsBean>) getIntent().getExtras().get("selectedGoods");
		adapter = new OrderConfirmAdapter(this, orderedGoods, R.layout.item_activity_order_confirm_selected_goods);
		for (GoodsBean bean : orderedGoods) {
			sum += bean.getSelectedNum()*bean.getPrice();
		}
	}

	private void initView() {
		orderAmount = (TextView) findViewById(R.id.tv_activity_order_taking_order_amount);
		realAmount = (TextView) findViewById(R.id.tv_activity_order_taking_real_amount);
		lvOrderedGoods = (ListView) findViewById(R.id.lv_activity_order_taking_ordered_goods);
		scrollVew = (PullToRefreshScrollView) findViewById(R.id.pull_refresh_scrollview);

		scrollVew.setMode(Mode.PULL_FROM_START);
		orderAmount.setText(sum+"元");
		realAmount.setText(sum+"元");
		lvOrderedGoods.setAdapter(adapter);
		setListViewHeightBasedOnChildren(lvOrderedGoods);
	}

	private void initEvent() {
		scrollVew.setOnRefreshListener(this);
	}


	/**
	 * 根据item的高度来决定listview的高度,解决scrollview内嵌listview的问题
	 * @param listView
	 */
	public void setListViewHeightBasedOnChildren(ListView listView) {
	    if(listView == null) return;
	    ListAdapter listAdapter = listView.getAdapter();
	    if (listAdapter == null) {
	        return;
	    }
	    int totalHeight = 0;
	    for (int i = 0; i < listAdapter.getCount(); i++) {
	        View listItem = listAdapter.getView(i, null, listView);
	        listItem.measure(0, 0);
	        totalHeight += listItem.getMeasuredHeight();
	    }
	    ViewGroup.LayoutParams params = listView.getLayoutParams();
	    params.height = totalHeight + (listView.getDividerHeight() * (listAdapter.getCount() - 1));
	    listView.setLayoutParams(params);
	}

	@Override
	public void onPullDownToRefresh(PullToRefreshBase<ScrollView> refreshView) {
		Toast.makeText(OrderTakingActivity.this, "pull down", 0).show();
		refreshView.onRefreshComplete();
	}

	@Override
	public void onPullUpToRefresh(PullToRefreshBase<ScrollView> refreshView) {
	}
}
